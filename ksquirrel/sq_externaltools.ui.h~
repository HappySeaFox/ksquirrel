/****************************************************************************
** ui.h extension file, included from the uic-generated form implementation.
**
** If you wish to add, delete or rename functions or slots use
** Qt Designer which will update this file, preserving your code. Create an
** init() function in place of a constructor, and a destroy() function in
** place of a destructor.
*****************************************************************************/

#include <kiconloader.h>

void SQ_ExternalTools::init()
{
     listTools->setSorting(-1);

    	int count = SQ_ExternalTool::instance()->count();
	QListViewItem *itemafter = 0L, *item;

	for(int i = 0;i < count;i++)
	{
		if(itemafter)
		    item = new QListViewItem(listTools, itemafter, "", SQ_ExternalTool::instance()->getToolName(i), SQ_ExternalTool::instance()->getToolCommand(i), SQ_ExternalTool::instance()->getToolType(i), SQ_ExternalTool::instance()->getToolPixmap(i));
		else
		item = new QListViewItem(listTools, "", SQ_ExternalTool::instance()->getToolName(i), SQ_ExternalTool::instance()->getToolCommand(i), SQ_ExternalTool::instance()->getToolType(i), SQ_ExternalTool::instance()->getToolPixmap(i));
		item->setPixmap(0, KSquirrel::loader()->loadIcon(item->text(4), KIcon::Desktop, 16));
	itemafter = item;

	    item->setRenameEnabled(1, true);
	    item->setRenameEnabled(2, true);
	    item->setMultiLinesEnabled(false);
	    
	    listTools->insertItem(item);
	}

	pushToolUp->setPixmap(KSquirrel::loader()->loadIcon("move_task_up", KIcon::Desktop, KIcon::SizeSmall));
	pushToolDown->setPixmap(KSquirrel::loader()->loadIcon("move_task_down", KIcon::Desktop, KIcon::SizeSmall));
	pushNew->setPixmap(KSquirrel::loader()->loadIcon("filenew", KIcon::Desktop, KIcon::SizeSmall));
	pushDelete->setPixmap(KSquirrel::loader()->loadIcon("editdelete", KIcon::Desktop, KIcon::SizeSmall));
	pushClearAll->setPixmap(KSquirrel::loader()->loadIcon("edittrash", KIcon::Desktop, KIcon::SizeSmall));
	pushHelp->setPixmap(KSquirrel::loader()->loadIcon("help", KIcon::Desktop, KIcon::SizeSmall));

	listTools->setCurrentItem(listTools->firstChild());
	listTools->clearSelection();
	listTools->setSelected(listTools->currentItem(), true);
}

void SQ_ExternalTools::slotNewTool()
{
	QListViewItem *itemafter = listTools->lastItem(), *item;

	if(itemafter)
		item = new QListViewItem(listTools, itemafter, "", "Tool name", "tool_executable %f", "local", "");
	else
		item = new QListViewItem(listTools,  "", "Tool name", "tool_executable %f", "local", "");

	item->setRenameEnabled(1, true);
	item->setRenameEnabled(2, true);
	item->setMultiLinesEnabled(false);
	listTools->insertItem(item);
	item->startRename(1);
}

void SQ_ExternalTools::slotToolClear()
{
	QListViewItem *item = listTools->currentItem();
    
	if(!item) return;
    
	listTools->takeItem(item);
	
	item = listTools->currentItem();

	if(item)
	    listTools->setSelected(item, true);
}

void SQ_ExternalTools::slotToolUp()
{
    QListViewItem *item = listTools->currentItem();
    
    if(!item) return;
 
    QListViewItem *itemafter = item->itemAbove();
    
    if(!itemafter) return;
 
    itemafter->moveItem(item);

}

void SQ_ExternalTools::slotToolDown()
{
    QListViewItem *item = listTools->currentItem();
    
    if(!item) return;
 
    QListViewItem *itemafter = item->itemBelow();
    
    if(!itemafter) return;
 
    item->moveItem(itemafter);

}

int SQ_ExternalTools::start()
{
     int result = exec();
    
    if(result == QDialog::Accepted)
    {
	QListViewItem *cur = listTools->firstChild();
	
	SQ_ExternalTool::instance()->clear();

	for(;cur;cur = cur->itemBelow())
	{
		SQ_ExternalTool::instance()->addTool(cur->text(4), cur->text(1), cur->text(2), cur->text(3));
	}
    }
    
    return result;
}

void SQ_ExternalTools::slotToolRenameRequest( QListViewItem *item, const QPoint &, int pos )
{
    if(!item || pos == -1)
	return;
    
    if(pos > 0)
	item->startRename(pos);
    else
    {
	KIconDialog dialog(KSquirrel::loader());
	dialog.setup(KIcon::Desktop, KIcon::Application, true, 16);
	QString result = dialog.openDialog();
	
	if(result != QString::null)
	{
	    item->setPixmap(0, KSquirrel::loader()->loadIcon(result, KIcon::Desktop, 16));
	    item->setText(4, result);
	}
    }
 }

void SQ_ExternalTools::slotHelp()
{
    QWhatsThis::display(tr2i18n("<b>Command</b> can contain <ul><li>%f: one file<li>%F: multiple files</ul>"));
}
